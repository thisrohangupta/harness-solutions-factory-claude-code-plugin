#!/usr/bin/env bash
# Generate terraform.tfvars from JSON input
# Usage: generate-tfvars.sh <module-dir> '<json-values>'
# Example: generate-tfvars.sh harness-organization '{"organization_name":"My Org"}'
set -euo pipefail

MODULE_DIR="$1"
JSON_VALUES="$2"
REPO_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
TARGET_DIR="$REPO_ROOT/$MODULE_DIR"
OUTPUT_FILE="$TARGET_DIR/terraform.tfvars"

if [ ! -d "$TARGET_DIR" ]; then
    echo "ERROR: Module directory $TARGET_DIR does not exist" >&2
    exit 1
fi

# Generate tfvars using Python for reliable HCL formatting
python3 -c "
import json, sys

values = json.loads('''$JSON_VALUES''')
lines = []
lines.append('# Generated by Harness Factory Plugin')
lines.append('# Module: $MODULE_DIR')
lines.append('')

for key, value in values.items():
    if value is None:
        lines.append(f'{key} = null')
    elif isinstance(value, bool):
        lines.append(f'{key} = {str(value).lower()}')
    elif isinstance(value, str):
        # Escape quotes in strings
        escaped = value.replace('\\\\', '\\\\\\\\').replace('\"', '\\\\\"')
        lines.append(f'{key} = \"{escaped}\"')
    elif isinstance(value, (int, float)):
        lines.append(f'{key} = {value}')
    elif isinstance(value, list):
        items = []
        for item in value:
            if isinstance(item, str):
                items.append(f'\"{item}\"')
            else:
                items.append(str(item))
        lines.append(f'{key} = [{', '.join(items)}]')
    elif isinstance(value, dict):
        lines.append(f'{key} = {{')
        for k, v in value.items():
            if isinstance(v, str):
                lines.append(f'  {k} = \"{v}\"')
            elif isinstance(v, bool):
                lines.append(f'  {k} = {str(v).lower()}')
            elif v is None:
                lines.append(f'  {k} = null')
            else:
                lines.append(f'  {k} = {v}')
        lines.append('}')

with open('$OUTPUT_FILE', 'w') as f:
    f.write('\n'.join(lines) + '\n')

print(f'Generated $OUTPUT_FILE')
"
