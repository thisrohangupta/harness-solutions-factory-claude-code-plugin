template:
  identifier: ${TEMPLATE_IDENTIFIER}
  name: ${TEMPLATE_NAME}
  versionLabel: "${TEMPLATE_VERSION}"
  description: ${TEMPLATE_DESCRIPTION}
  tags:
    ${indent(4, TAGS)}
  type: StepGroup  
  icon: data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIgogICB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiCiAgIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICAgeG1sbnM6c29kaXBvZGk9Imh0dHA6Ly9zb2RpcG9kaS5zb3VyY2Vmb3JnZS5uZXQvRFREL3NvZGlwb2RpLTAuZHRkIgogICB4bWxuczppbmtzY2FwZT0iaHR0cDovL3d3dy5pbmtzY2FwZS5vcmcvbmFtZXNwYWNlcy9pbmtzY2FwZSIKICAgdmVyc2lvbj0iMS4xIgogICBpZD0ibGF5ZXIiCiAgIHg9IjBweCIKICAgeT0iMHB4IgogICB2aWV3Qm94PSIwIDAgNDAwIDQwMCIKICAgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIKICAgc29kaXBvZGk6ZG9jbmFtZT0iaWNvbi5zdmciCiAgIHdpZHRoPSI0MDAiCiAgIGhlaWdodD0iNDAwIgogICBpbmtzY2FwZTp2ZXJzaW9uPSIxLjAuMSAoMS4wLjErcjczKSIKICAgaW5rc2NhcGU6ZXhwb3J0LWZpbGVuYW1lPSIvaG9tZS9qb2huL0Rvd25sb2Fkcy9hbnNpYmxlLWljb24ucG5nIgogICBpbmtzY2FwZTpleHBvcnQteGRwaT0iNDgiCiAgIGlua3NjYXBlOmV4cG9ydC15ZHBpPSI0OCI+PG1ldGFkYXRhCiAgIGlkPSJtZXRhZGF0YTQ1Ij48cmRmOlJERj48Y2M6V29yawogICAgICAgcmRmOmFib3V0PSIiPjxkYzpmb3JtYXQ+aW1hZ2Uvc3ZnK3htbDwvZGM6Zm9ybWF0PjxkYzp0eXBlCiAgICAgICAgIHJkZjpyZXNvdXJjZT0iaHR0cDovL3B1cmwub3JnL2RjL2RjbWl0eXBlL1N0aWxsSW1hZ2UiIC8+PGRjOnRpdGxlPjwvZGM6dGl0bGU+PC9jYzpXb3JrPjwvcmRmOlJERj48L21ldGFkYXRhPjxkZWZzCiAgIGlkPSJkZWZzNDMiPgoJCgkKCQoJCgkKCQoJCgkKCQoJCgkKCQoJCgkKCQoJCgkKPC9kZWZzPjxzb2RpcG9kaTpuYW1lZHZpZXcKICAgcGFnZWNvbG9yPSIjZmZmZmZmIgogICBib3JkZXJjb2xvcj0iIzY2NjY2NiIKICAgYm9yZGVyb3BhY2l0eT0iMSIKICAgb2JqZWN0dG9sZXJhbmNlPSIxMCIKICAgZ3JpZHRvbGVyYW5jZT0iMTAiCiAgIGd1aWRldG9sZXJhbmNlPSIxMCIKICAgaW5rc2NhcGU6cGFnZW9wYWNpdHk9IjAiCiAgIGlua3NjYXBlOnBhZ2VzaGFkb3c9IjIiCiAgIGlua3NjYXBlOndpbmRvdy13aWR0aD0iMTkyMCIKICAgaW5rc2NhcGU6d2luZG93LWhlaWdodD0iOTc3IgogICBpZD0ibmFtZWR2aWV3NDEiCiAgIHNob3dncmlkPSJmYWxzZSIKICAgaW5rc2NhcGU6cGFnZWNoZWNrZXJib2FyZD0idHJ1ZSIKICAgaW5rc2NhcGU6em9vbT0iMS4wMjM3ODY1IgogICBpbmtzY2FwZTpjeD0iMTgxLjQ2OTk2IgogICBpbmtzY2FwZTpjeT0iMjQ3Ljg1ODcxIgogICBpbmtzY2FwZTp3aW5kb3cteD0iMCIKICAgaW5rc2NhcGU6d2luZG93LXk9IjM0IgogICBpbmtzY2FwZTp3aW5kb3ctbWF4aW1pemVkPSIxIgogICBpbmtzY2FwZTpjdXJyZW50LWxheWVyPSJsYXllciIKICAgaW5rc2NhcGU6ZG9jdW1lbnQtcm90YXRpb249IjAiIC8+CjxzdHlsZQogICB0eXBlPSJ0ZXh0L2NzcyIKICAgaWQ9InN0eWxlMiI+Cgkuc3Qwe2ZpbGw6I0NDMDAwMDt9Cgkuc3Qxe2ZpbGw6I0ZGRkZGRjt9Cjwvc3R5bGU+CjxnCiAgIGlkPSJnNTUiCiAgIHRyYW5zZm9ybT0ibWF0cml4KDIuMTExOTQzNSwwLDAsMi4xMTE5NDM1LC02Ljk0MzE4MzksLTY5Ni40NzAzOSkiPjxjaXJjbGUKICAgICBjbGFzcz0ic3QwIgogICAgIGN4PSI5Ny45ODcwODMiCiAgICAgY3k9IjQyNC40NzY1IgogICAgIHI9IjcxLjAyNDYyOCIKICAgICBpZD0iY2lyY2xlMzQiCiAgICAgc3R5bGU9ImZpbGw6I2NjMDAwMDtzdHJva2Utd2lkdGg6MC43NDk5OTYiIC8+PHBhdGgKICAgICBjbGFzcz0ic3QxIgogICAgIGQ9Im0gMTMxLjg4NjkxLDQ1Mi42MDEzMyAtMjguMzQ5ODUsLTY4LjA5OTY0IGMgLTAuNjc1LC0xLjc5OTk5IC0yLjM5OTk5LC0zLjA3NDk5IC00LjM0OTk4MiwtMi45OTk5OSAtMi4wMjQ5ODksLTAuMDc1IC0zLjgyNDk4LDEuMiAtNC40OTk5NzYsMi45OTk5OSBMIDYzLjcxMjI2NCw0NTkuMTI2MyBoIDEwLjY0OTk0NCBsIDEyLjIyNDkzNiwtMzAuNzQ5ODQgMzYuNjc0ODA2LDI5LjYyNDg0IGMgMS4wNSwxLjA1IDIuNDc0OTksMS42NSAzLjg5OTk4LDEuNzI1IDIuNzc0OTksMC4wNzUgNS4wOTk5OCwtMi4wOTk5OSA1LjE3NDk4LC00Ljk0OTk4IHYgLTAuMTUgYyAtMC4wNzUsLTAuNjc0OTkgLTAuMjI1LC0xLjM0OTk5IC0wLjQ1LC0yLjAyNDk5IHogTSA5OS4yNjIwNzgsMzk2LjgwMTYyIDExNy42MzY5OCw0NDIuMTc2MzkgODkuODg3MTI3LDQyMC4yNzY1IFoiCiAgICAgaWQ9InBhdGgzNiIKICAgICBpbmtzY2FwZTpjb25uZWN0b3ItY3VydmF0dXJlPSIwIgogICAgIHN0eWxlPSJmaWxsOiNmZmZmZmY7c3Ryb2tlLXdpZHRoOjAuNzQ5OTk2IiAvPjwvZz4KPC9zdmc+Cg==
  spec:
    stageType: ${TEMPLATE_STAGE_TYPE}
    steps:
      - step:
          type: GitClone
          name: clone repo
          identifier: clone_repo
          spec:

%{~ if !HARNESS_CODE ~}
            connectorRef: <+input>
%{~ endif ~}

            repoName: <+input>
            build: <+input>
      - step:
          type: Run
          name: ansible playbook
          identifier: ansible_playbook
          spec:
            connectorRef: ${DOCKER_CONNECTOR}
            image: ${IMAGE}:<+stepGroup.variables.ansibleVersion>
            shell: Bash
            command: |-
              cd <+steps.clone_repo.spec.repoName>

              ## All hosts are new hosts, skip verification
              mkdir -p ~/.ssh
              echo 'Host *
                  StrictHostKeyChecking no' > ~/.ssh/config
              chmod 400 ~/.ssh/config

              ## Set ssh key for connecting to targets
              echo '<+stepGroup.variables.sshKeySecretRef>' | base64 -d > $SSH_KEY
              chmod 600 $SSH_KEY


              ## Select the verbosity level for ansible
              case "<+stepGroup.variables.verbosity>" in
                Normal)
                  verbose_string="-v"
                  ;;
                Verbose)
                  verbose_string="-vv"
                  ;;
                MoreVerbose)
                  verbose_string="-vvv"
                  ;;
                Debug)
                  verbose_string="-vvv"
                  ;;
                ConnectionDebug)
                  verbose_string="-vvvv"
                  ;;
                AdvancedDebug)
                  verbose_string="-vvvvv"
                  ;;
                "")
                  verbose_string="-v"
                  ;;
                *)
                  verbose_string="-v"
                  ;;
              esac

              ## Set vault password
              if [ "<+stepGroup.variables.ansibleVaultPasswordSecretRef>" == "null" ]
              then
                echo "no vault password set"
              else
                echo '<+stepGroup.variables.ansibleVaultPasswordSecretRef>' > $VAULT_PASSWORD
              fi

              # Download dependencies
              if [ "<+stepGroup.variables.requirementsFile>" == "" ]
              then
                echo "no requirements file"
              else
                ansible-galaxy install --force -r "<+stepGroup.variables.requirementsFile>"
              fi

              # Execute playbooks based on optional flags given
              if [[ "<+stepGroup.variables.skiptags>" == "null" || "<+stepGroup.variables.skiptags>" == "" ]]
              then
                if [[ "<+stepGroup.variables.limit>" == "null" || "<+stepGroup.variables.limit>" == "" ]]
                then
                   ansible-playbook -i "<+stepGroup.variables.inventoryFile>" "<+stepGroup.variables.playbookFile>" -e '<+stepGroup.variables.extraVars>' --private-key $SSH_KEY --vault-password-file=$VAULT_PASSWORD $verbose_string
                else
                   ansible-playbook -i "<+stepGroup.variables.inventoryFile>" "<+stepGroup.variables.playbookFile>" -e '<+stepGroup.variables.extraVars>' --private-key $SSH_KEY --vault-password-file=$VAULT_PASSWORD --limit <+stepGroup.variables.limit> $verbose_string
                fi
              else
                if [[ "<+stepGroup.variables.limit>" == "null" || "<+stepGroup.variables.limit>" == "" ]]
                then
                  ansible-playbook -i "<+stepGroup.variables.inventoryFile>" "<+stepGroup.variables.playbookFile>" -e '<+stepGroup.variables.extraVars>' --private-key $SSH_KEY --vault-password-file=$VAULT_PASSWORD --skip-tags <+stepGroup.variables.skiptags>  $verbose_string
                else
                  ansible-playbook -i "<+stepGroup.variables.inventoryFile>" "<+stepGroup.variables.playbookFile>" -e '<+stepGroup.variables.extraVars>' --private-key $SSH_KEY --vault-password-file=$VAULT_PASSWORD --skip-tags <+stepGroup.variables.skiptags> --limit <+stepGroup.variables.limit> $verbose_string
                fi
              fi
            envVariables:
              SSH_KEY: ./key
              VAULT_PASSWORD: ./vault
    stepGroupInfra:
${GROUP_INFRASTRUCTURE}
    variables:
      - name: ansibleVersion
        type: String
        value: <+input>.default(latest)
        description: Ansible core version to run
        required: true
      - name: inventoryFile
        type: String
        value: <+input>
        description: Path to inventory file in repo
        required: true
      - name: playbookFile
        type: String
        value: <+input>
        description: Path to playbook file in repo
        required: true
      - name: verbosity
        type: String
        value: <+input>.default(Normal).allowedValues(Normal,Verbose,MoreVerbose,Debug,ConnectionDebug,AdvancedDebug)
        description: Verbosity level for ansible-playbook command
        required: false
      - name: requirementsFile
        type: String
        value: <+input>
        description: Path to ansible requirements file in repo
        required: false
      - name: extraVars
        type: String
        value: <+input>.default({})
        description: Extra ansible variables to set
        required: false
        default: "{}"
      - name: ansibleVaultPasswordSecretRef
        type: Secret
        value: <+input>
        description: Harness [text] secret reference to ansible vault password
        required: false
      - name: sshKeySecretRef
        type: Secret
        value: <+input>
        description: Harness [text] secret reference to a base64 encoded SSH key
        required: true
      - name: limit
        type: String
        value: <+input>
        description: Inventory limit string
        required: false
      - name: skiptags
        type: String
        value: <+input>
        description: Tags to skip during play
        required: false
