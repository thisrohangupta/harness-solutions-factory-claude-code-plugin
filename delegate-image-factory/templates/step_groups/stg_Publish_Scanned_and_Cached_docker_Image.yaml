template:
  identifier: ${TEMPLATE_IDENTIFIER}
  name: ${TEMPLATE_NAME}
  orgIdentifier: ${ORGANIZATION_ID}
  projectIdentifier: ${PROJECT_ID}
  versionLabel: v1
  type: StepGroup
  tags:
    ${indent(4, TAGS)}
  spec:
    stageType: CI
    steps:
      %{~ if GENERATE_LOCAL_DOCKERFILE ~}
      - step:
          type: Run
          name: Generate Local Dockerfile
          identifier: Generate_Local_Dockerfile
          spec:
            %{~ if KUBERNETES_CONNECTOR != "skipped" ~}
            connectorRef: ${KUBERNETES_CONNECTOR}
            image: bash
            %{~ endif ~}
            shell: Bash
            command: |-
              set -eo pipefail
              cat <<EOF > Dockerfile
              FROM $IMAGE:$TAG
              EOF
            envVariables:
              IMAGE: <+stepGroup.variables.BUILD_TARGET_IMAGE>
              TAG: <+stepGroup.variables.CACHE_TARGET_TAG>
      %{~ endif ~}
      ${HARNESS_CONTAINER_REGISTRY ~}
    variables:
      - name: BUILD_TARGET_IMAGE
        type: String
        value: <+input>.default(<+stage.variables.REGISTRY_NAME>/<+stage.variables.IMAGE_NAME>)
        description: "Combined Repo and Image name to be used as the build target"
        required: true
      - name: BUILD_TARGET_TAG
        type: String
        value: <+input>
        description: "Build Target Tag"
        required: true
      %{~ if CACHE_TARGET_TAG ~}
      - name: CACHE_TARGET_TAG
        type: String
        value: <+input>.default(<+stage.variables.CACHE_TARGET_TAG>)
        description: "Build Target Repository caching tag"
        required: true
      %{~ endif ~}
      %{~ if BUILD_TARGET_ARGS ~}
      - name: BUILD_TARGET_ARGS
        type: String
        value: <+input>
        description: "Stringified JSON object of Build Arguments"
        required: true
      %{~ endif ~}
      %{~ if BUILD_DOCKERFILE ~}
      - name: BUILD_DOCKERFILE
        type: String
        value: <+input>
        description: "Local path to Dockerfile"
        required: true
      %{~ endif ~}
      %{~ if BUILD_CONTEXT ~}
      - name: BUILD_CONTEXT
        type: String
        value: <+input>.default(".")
        description: "Docker Context"
        required: true
      %{~ endif ~}
