apiVersion: harness.io/v1
kind: Workflow
identifier: harnessdelegateimagefactory
name: Harness Delegate Image Factory
owner: group:default/HSF_Admins
type: harness_factory
metadata:
  description: |
    The Harness Delegate Images Factory is a robust Harness pipeline designed to create and manage the lifecycle of customized Harness Delegate Images.

    Learn More in the TechDocs
  tags:
    - account-management
    - solutions-factory
    - harness
  # TODO: 2025-07-29
  # Disabling this due to an issue with the loading of the TechDocs
  # annotations:
  #   backstage.io/techdocs-ref: dir:.
spec:
  parameters:
    - title: Deploy the Harness Delegate Image Factory
      description: |
        ---
        The Delegate Image Factory requires an existing Build Infrastructure configuration to be in place. This solution will support
        deployments via Kubernetes or Harness Cloud deployments.
      properties:
        # The token property needs to be in the first page of the workflow
        token:
          title: Harness Token
          type: string
          ui:widget: password
          ui:field: HarnessAuthToken
        build_infrastructure_type:
          title: Choose your Build Farm Infrastructure configuration
          type: string
          default: build_farm
          enum:
            - build_farm
            - cloud
            - custom
          enumNames:
            - Central Build Farm Infrastructure Only
            - Leverage Harness CI Cloud Infrastructure
            - Self-Hosted Kubernetes Infrastructure
        infra_defaults:
          title: infra_defaults
          type: object
          ui:widget: hidden
          properties:
            kubernetes_connector:
              type: string
              default: account.buildfarm_infrastructure
            kubernetes_namespace:
              type: string
              default: default
            kubernetes_override_image_connector:
              type: string
              default: ""
            kubernetes_node_selectors:
              type: string
              default: ""
            container_registry_connector_id:
              type: string
              default: account.buildfarm_container_registry
            container_registry_connector_cloud_id:
              type: string
              default: account.buildfarm_container_registry_cloud
            git_repository_name:
              type: string
              default: harness-delegate-setup
            git_connector_ref:
              type: string
              default: account.buildfarm_source_code_manager
            git_connector_cloud_ref:
              type: string
              default: account.buildfarm_source_code_manager_cloud
            existing_harness_platform_key_ref:
              type: string
              default: org.hsf_platform_api_key
      dependencies:
        build_infrastructure_type:
          allOf:
            - if:
                properties:
                  build_infrastructure_type:
                    const: "custom"
              then:
                required:
                  - kubernetes_connector
                  - kubernetes_namespace
                properties:
                  kubernetes_connector:
                    title: Existing Kubernetes Infrastructure Connector Reference
                    type: string
                    description: Enter the existing Kubernetes connector if local K8s execution should be used when running the Execution pipeline.  Must exist before execution.
                  kubernetes_namespace:
                    title: Existing Kubernetes Infrastructure Namespace
                    type: string
                    description: Enter the existing Kubernetes namespace if local K8s execution should be used when running the Execution pipeline.  Must exist before execution
                  kubernetes_override_image_connector:
                    title: Existing Override Image Container Connector Reference
                    type: string
                    description: Enter an existing Container Registry connector to use which overrides the default connector.  Must exist before execution
                  kubernetes_node_selectors:
                    title: Map of Kubernetes Node Selectors (Must be in key:value JSON)
                    type: object
                    description: Optional Kubernetes Node Selectors
                    additionalProperties:
                      type: string
    - title: Container Registry Configuration
      required:
        - container_registry_name
        - container_registry_type
      properties:
        use_build_farm_registry:
          title: Configure this solution to use the Centralized Build Farm Container Registry?
          type: boolean
          default: true
        container_registry_type:
          title: Choose your Container Registry Type
          type: string
          enum:
            - docker
          enumNames:
            - Docker/Artifactory Container Registry
          default: docker
        container_registry_name:
          title: Existing Container Registry Name
          type: string
          description: Docker Registry Name to which the container will be published
      dependencies:
        use_build_farm_registry:
          allOf:
            - if:
                properties:
                  use_build_farm_registry:
                    const: false
              then:
                required:
                  - container_registry_connector_id
                properties:
                  container_registry_connector_id:
                    title: Existing Container Registry Connector Reference
                    type: string
                    description: Existing Docker Registry Connector Id.  Must exist before execution
    - title: Source Code Manager Configuration
      properties:
        source_code_manager_type:
          title: Choose your Source Code Manager option for the repository
          type: string
          default: hcr
          enum:
            - hcr
            - build_farm
            - custom
          enumNames:
            - Setup a new Harness Code Repository?
            - Use Central Build Farm Source Code Manager?
            - Bring Your Own Connector?
      dependencies:
        source_code_manager_type:
          allOf:
            - if:
                properties:
                  source_code_manager_type:
                    const: "build_farm"
              then:
                required:
                  - git_repository_name
                properties:
                  git_repository_name:
                    title: GIT Repository Name
                    type: string
                    description: The source CodeBase Repository Name
                    default: harness-delegate-setup
            - if:
                properties:
                  source_code_manager_type:
                    const: "custom"
              then:
                required:
                  - git_repository_name
                  - git_connector_ref
                properties:
                  git_connector_ref:
                    title: Existing GIT Connector Reference
                    type: string
                    description: Provide an existing Source Code Manager Connector Reference
                    default: account.buildfarm_source_code_manager
                  git_repository_name:
                    title: GIT Repository Name
                    type: string
                    description: The source CodeBase Repository Name
                    default: harness-delegate-setup
    - title: Harness Security Test and SBOM Configuration
      properties:
        include_image_test_scan:
          title: Include image Security Scanning steps?
          type: boolean
          description: "Note: Requires Harness Security Test Orchestration Module"
          default: true
        include_image_sbom:
          title: Include Harness Software Bill of Materials?
          description: "Note: Requires Harness Software Supply Chain Assurance Module"
          type: boolean
          default: true
      dependencies:
        include_image_test_scan:
          allOf:
            - if:
                properties:
                  include_image_test_scan:
                    const: true
              then:
                required:
                  - sto_scanner_type
                properties:
                  sto_scanner_type:
                    title: Choose your Container Scanner Type
                    type: string
                    description: Harness STO Scanner Type
                    enum:
                      - aqua_trivy
                    enumNames:
                      - Aqua Trivy Container Scans
                    default: aqua_trivy
    - title: Delegate Image Factory Configuration
      properties:
        use_solution_factory_secret:
          title: Use the default Harness Solutions Factory API Token?
          type: boolean
          default: true
      dependencies:
        use_solution_factory_secret:
          allOf:
            - if:
                properties:
                  use_solution_factory_secret:
                    const: false
              then:
                required:
                  - existing_harness_platform_key_ref
                properties:
                  existing_harness_platform_key_ref:
                    title: "Harness API Secret Reference"
                    type: string
                    description: Provide an existing Harness Platform key secret reference.  Must exist before execution
    - title: Solutions Factory Connection
      properties:
        solutions_factory_details:
          title: Solutions Factory Details
          type: object
          description: |
            ---
            Harness URL : <+<+variable.account.solutions_factory_endpoint>.replaceFirst("/*$","")>

            Harness Account : <+account.identifier>

            Solutions Factory Org : <+variable.account.solutions_factory_org>

            Solutions Factory Project : <+variable.account.solutions_factory_project>
          required:
            - harness_account_url
            - harness_account_id
            - harness_org_id
            - harness_project_id
            - template_library_connector
            - template_library_repo
            - template_library_branch
            - template_library_directory
          properties:
            harness_account_url:
              type: string
              default: <+<+variable.account.solutions_factory_endpoint>.replaceFirst("/*$","")>
              ui:widget: hidden
            harness_account_id:
              type: string
              default: <+account.identifier>
              ui:widget: hidden
            harness_org_id:
              type: string
              default: <+variable.account.solutions_factory_org>
              ui:widget: hidden
            harness_project_id:
              type: string
              default: <+variable.account.solutions_factory_project>
              ui:widget: hidden
            template_library_connector:
              type: string
              default: <+variable.account.solutions_factory_template_library_connector>
              ui:widget: hidden
            template_library_repo:
              type: string
              default: <+variable.account.solutions_factory_template_library_repo>
              ui:widget: hidden
            template_library_branch:
              type: string
              default: main
              ui:widget: hidden
            template_library_directory:
              type: string
              default: delegate-image-factory
              ui:widget: hidden
        solutions_factory_opts:
          title: Solutions Factory Workflow Options
          type: object
          required:
            - repo_source
            - workspace_type
          properties:
            repo_source:
              type: string
              # Used to group by source the workspaces for bulk actions
              default: <+<+variable.account.solutions_factory_template_library_connector>.startsWith("org.Harness_Template_Library_Repo")?"official":"custom">
              ui:widget: hidden
            workspace_type:
              type: string
              # Used to group by type the workspaces for bulk actions
              default: delegate-image-factory
              ui:widget: hidden
            is_ephemeral:
              type: string
              # Determines if the workflow will trigger a temporary workspace that is
              # deleted upon completion. Resources will be preserved
              # Must be "true" or "false" and wrapped in quotes
              default: "false"
              ui:widget: hidden
            requires_approval:
              type: string
              # Determines if the workflow will require an Approval before executing
              # Must be "true" or "false" and wrapped in quotes
              default: "false"
              ui:widget: hidden
            use_mini_factory:
              type: string
              # "When enabled, IDP workflows will default to leveraging the mini-factory to distribute workloads
              # Value must be controlled through variable
              default: "false"
              ui:widget: hidden
  steps:
    - id: configure_workspace
      name: Configuring Harness Workspace
      action: trigger:harness-custom-pipeline
      input:
        url: ${{ parameters.solutions_factory_details.harness_account_url }}/ng/account/${{ parameters.solutions_factory_details.harness_account_id }}/all/orgs/${{ parameters.solutions_factory_details.harness_org_id }}/projects/${{ "hws_" if parameters.solutions_factory_opts.use_mini_factory=="true" else "" }}${{ parameters.organization_id if parameters.solutions_factory_opts.use_mini_factory=="true" else parameters.solutions_factory_details.harness_project_id }}/pipelines/Create_and_Manage_IACM_Workspaces/pipeline-studio?storeType=INLINE
        inputset:
          GIT_REPOSITORY_CONNECTOR: ${{ parameters.solutions_factory_details.template_library_connector }}
          GIT_REPOSITORY_NAME: ${{ parameters.solutions_factory_details.template_library_repo }}
          GIT_REPOSITORY_BRANCH: ${{ parameters.solutions_factory_details.template_library_branch }}
          GIT_REPOSITORY_PATH: ${{ parameters.solutions_factory_details.template_library_directory }}
          RESOURCE_NAME: harness-delegate-image-factory
          RESOURCE_OWNER: group:default/Account_Admins
          RESOURCE_VARS:
            organization_id: "${{ parameters.solutions_factory_details.harness_org_id }}"
            project_id: "Delegate_Management"
            kubernetes_connector: ${{ "skipped" if (parameters.build_infrastructure_type == "cloud") else ( parameters.infra_defaults.kubernetes_connector if (parameters.build_infrastructure_type == "build_farm") else parameters.kubernetes_connector ) }}
            kubernetes_namespace: ${{ "default" if (parameters.build_infrastructure_type == "cloud") else ( parameters.infra_defaults.kubernetes_namespace if (parameters.build_infrastructure_type == "build_farm") else parameters.kubernetes_namespace ) }}
            kubernetes_node_selectors: ${{ "{}" if (parameters.build_infrastructure_type == "cloud") else ( parameters.kubernetes_node_selectors if parameters.kubernetes_node_selectors else parameters.infra_defaults.kubernetes_node_selectors ) }}
            kubernetes_override_image_connector: ${{ "skipped" if (parameters.build_infrastructure_type == "cloud") else ( parameters.kubernetes_override_image_connector if parameters.kubernetes_override_image_connector else parameters.infra_defaults.kubernetes_override_image_connector ) }}
            container_registry_name: ${{ parameters.container_registry_name}}
            container_registry_type: ${{ parameters.container_registry_type }}
            container_registry_connector_id: ${{ (parameters.infra_defaults.container_registry_connector_cloud_id if (parameters.build_infrastructure_type == "cloud") else parameters.infra_defaults.container_registry_connector_id) if parameters.use_build_farm_registry else parameters.container_registry_connector_id }}
            git_repository_name: ${{ parameters.infra_defaults.git_repository_name if parameters.source_code_manager_type == "hcr" else parameters.git_repository_name }}
            git_connector_ref: ${{ "skipped" if parameters.source_code_manager_type == "hcr" else ( parameters.git_connector_ref if parameters.git_connector_ref else (parameters.infra_defaults.git_connector_cloud_ref if parameters.use_harness_cloud else parameters.infra_defaults.git_connector_ref) ) }}
            existing_harness_platform_key_ref: ${{ parameters.infra_defaults.existing_harness_platform_key_ref if parameters.use_solution_factory_secret else parameters.existing_harness_platform_key_ref }}
            include_image_test_scan: ${{ parameters.include_image_test_scan }}
            sto_scanner_type: ${{ parameters.sto_scanner_type if parameters.sto_scanner_type else "aqua_trivy" }}
            include_image_sbom: ${{ parameters.include_image_sbom }}
          RESOURCE_VARS_ENVS: {}
          RESOURCE_VARS_ENVS_SECRET: {}
          RESOURCE_VARS_SECRETS: {}
          INCLUDE_HARNESS_ENVS: "true"
          WORKSPACE_TAGS:
            source: ${{ parameters.solutions_factory_opts.repo_source }}
            type: ${{ parameters.solutions_factory_opts.workspace_type }}
          IS_EPHEMERAL: ${{ parameters.solutions_factory_opts.is_ephemeral }}
          REQUIRES_APPROVAL: ${{ parameters.solutions_factory_opts.requires_approval }}
        apikey: ${{ parameters.token }}
    - id: mirror_repository
      if: ${{ parameters.source_code_manager_type == "hcr" }}
      name: Mirror Harness Code Repository
      action: trigger:harness-custom-pipeline
      input:
        url: ${{ parameters.solutions_factory_details.harness_account_url }}/ng/account/${{ parameters.solutions_factory_details.harness_account_id }}/all/orgs/${{ parameters.solutions_factory_details.harness_org_id }}/projects/Delegate_Management/pipelines/Mirror_Harness_Delegate_Setup/pipeline-studio?storeType=INLINE
        inputset: {}
        apikey: ${{ parameters.token }}
        showOutputVariables: true
  output:
    links:
      # TODO: 2025-07-29
      # Disabling this due to an issue with the loading of the TechDocs
      # - title: Technical Documentation
      #   url: ../../docs/default/template/harness-delegate-image-factory/guide/
      - title: Source Repository - Delegate Image Factory
        url: https://git.harness.io/AM8HCbDiTXGQNrTIhNl7qQ/hcr/hsf/harness-delegate-setup.git
      - title: Harness Delegate Image Factory Pipeline
        url: ${{ steps.configure_workspace.output['pipeline.stages.Provision.spec.execution.steps.Provision.steps.apply.output.outputVariables.pipeline']}}
    text:
      - title: Next Steps
        content: |
          ## Your Harness Delegate Image Factory is operational
          ---
          Before proceeding, please take a moment to review the following requirements

          ### Step 1) - Manage your Harness Respository ${{ "- Done" if parameters.source_code_manager_type == "hcr" else "- Required"}}
          ---
          This factory depends on the specified Git Repository **(${{ parameters.infra_defaults.git_repository_name if parameters.source_code_manager_type == "hcr" else parameters.git_repository_name }})** exists and contains the source code.

          ---
          1) Begin by cloning the source repository from Harness locally.
          https://git.harness.io/AM8HCbDiTXGQNrTIhNl7qQ/hcr/hsf/harness-delegate-setup.git

          2) Push the repository to your internal SCM based on the details provided

              Repository: ${{ steps.configure_workspace.output['pipeline.stages.Provision.spec.execution.steps.Provision.steps.apply.output.outputVariables.repository_url']}}

              ---
              Branch: ${{ steps.configure_workspace.output['pipeline.stages.Provision.spec.execution.steps.Provision.steps.apply.output.outputVariables.repository_branch']}}


          ### Step 2) - Build your custom delegate image
          ---
          Launch the Pipeline by clicking this Link above - **Harness Delegate Image Factory Pipeline**
