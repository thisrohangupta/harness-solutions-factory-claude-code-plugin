apiVersion: harness.io/v1
kind: Workflow
identifier: harnessciimagefactory
name: Harness Image Factory
owner: group:default/HSF_Admins
type: harness_factory
metadata:
  description: |
    The Harness Image Factory is a robust Harness pipeline designed to mirror and replicate the lifecycle of images used by Harness module steps
  tags:
    - account-management
    - solutions-factory
    - harness
    - pipeline
    - hidden
spec:
  parameters:
    - title: Harness Image Factory Build Infrastructure
      description: |
        ---
        The Harness Image Factory requires an existing Build Infrastructure configuration to be in place. This solution will support
        deployments via Kubernetes or Harness Cloud deployments.
      required:
        - build_infrastructure_type
      properties:
        # The token property needs to be in the first page of the workflow
        token:
          title: Harness Token
          type: string
          ui:widget: password
          ui:field: HarnessAuthToken
        build_infrastructure_type:
          title: Choose your Build Farm Infrastructure configuration
          type: string
          default: build_farm
          enum:
            - build_farm
            - cloud
            - custom
          enumNames:
            - Central Build Farm Infrastructure Only
            - Leverage Harness CI Cloud Infrastructure
            - Self-Hosted Kubernetes Infrastructure
        infra_defaults:
          title: infra_defaults
          type: object
          ui:widget: hidden
          properties:
            kubernetes_connector:
              type: string
              default: account.buildfarm_infrastructure
            kubernetes_namespace:
              type: string
              default: default
            kubernetes_override_image_connector:
              type: string
              default: ""
            kubernetes_node_selectors:
              type: string
              default: ""
            harness_ci_image_source_repository:
              type: string
              default: us-docker.pkg.dev/gar-prod-setup/harness-public/
            container_registry_username_ref:
              type: string
              default: account.buildfarm_container_registry_username
            container_registry_password_ref:
              type: string
              default: account.buildfarm_container_registry_password
            pipeline_step_connector_ref:
              type: string
              default: account.harnessImage
            harness_image_migration_image:
              type: string
              default: plugins/image-migration
            hsf_script_mgr_image:
              type: string
              default: harnesssolutionfactory/harness-python-api-sdk:latest
            max_concurrency:
              type: number
              default: 5
            scheduled_pipeline_execution_frequency:
              type: string
              default: "0 2 * * *"
      dependencies:
        build_infrastructure_type:
          allOf:
            - if:
                properties:
                  build_infrastructure_type:
                    const: "custom"
              then:
                required:
                  - kubernetes_connector
                  - kubernetes_namespace
                properties:
                  kubernetes_connector:
                    title: Existing Kubernetes Infrastructure Connector Reference
                    type: string
                    description: Enter the existing Kubernetes connector if local K8s execution should be used when running the Execution pipeline.  Must exist before execution.
                  kubernetes_namespace:
                    title: Existing Kubernetes Infrastructure Namespace
                    type: string
                    description: Enter the existing Kubernetes namespace if local K8s execution should be used when running the Execution pipeline.  Must exist before execution
                  kubernetes_override_image_connector:
                    title: Existing Override Image Container Connector Reference
                    type: string
                    description: Enter an existing Container Registry connector to use which overrides the default connector.  Must exist before execution
                  kubernetes_node_selectors:
                    title: Map of Kubernetes Node Selectors (Must be in key:value JSON)
                    type: object
                    description: Optional Kubernetes Node Selectors
                    additionalProperties:
                      type: string
    - title: Pipeline Input Variables
      required:
        - modules
      properties:
        modules:
          title: Modules to manage
          description: Select the modules to manage images for
          type: array
          items:
            type: string
            enum:
              - ci
              - idp
              - iacm-manager
            enumNames:
              - CI
              - IDP
              - IACM
          uniqueItems: true
        use_harness_public_gar_registry:
          title: Pull the CI images directly from the Harness GAR Repository
          description: Images will be pulled from the following registry - us-docker.pkg.dev/gar-prod-setup/harness-public/
          type: boolean
          default: true
      dependencies:
        use_harness_public_gar_registry:
          allOf:
            - if:
                properties:
                  use_harness_public_gar_registry:
                    const: true
              then:
                required:
                  - customer_image_target_repository
                properties:
                  customer_image_target_repository:
                    $ref: "#/pipe_defaults/customer_image_target_repository"
                  should_use_build_farm_credentials:
                    $ref: "#/pipe_defaults/should_use_build_farm_credentials"
            - if:
                properties:
                  use_harness_public_gar_registry:
                    const: false
              then:
                required:
                  - harness_ci_image_source_repository
                  - customer_image_target_repository
                properties:
                  harness_ci_image_source_repository:
                    $ref: "#/pipe_defaults/harness_ci_image_source_repository"
                  customer_image_target_repository:
                    $ref: "#/pipe_defaults/customer_image_target_repository"
                  should_use_build_farm_credentials:
                    $ref: "#/pipe_defaults/should_use_build_farm_credentials"
        should_use_build_farm_credentials:
          allOf:
            - if:
                properties:
                  should_use_build_farm_credentials:
                    const: true
              then:
                properties:
                  should_update_harness_mgr:
                    $ref: "#/pipe_defaults/should_update_harness_mgr"
                  should_trigger_pipeline_on_schedule:
                    $ref: "#/pipe_defaults/should_trigger_pipeline_on_schedule"
            - if:
                properties:
                  should_use_build_farm_credentials:
                    const: false
              then:
                required:
                  - container_registry_username_ref
                  - container_registry_password_ref
                properties:
                  container_registry_username_ref:
                    $ref: "#/pipe_defaults/container_registry_username_ref"
                  container_registry_password_ref:
                    $ref: "#/pipe_defaults/container_registry_password_ref"
                  should_update_harness_mgr:
                    $ref: "#/pipe_defaults/should_update_harness_mgr"
                  should_trigger_pipeline_on_schedule:
                    $ref: "#/pipe_defaults/should_trigger_pipeline_on_schedule"
        should_trigger_pipeline_on_schedule:
          allOf:
            - if:
                properties:
                  should_trigger_pipeline_on_schedule:
                    const: true
              then:
                properties:
                  scheduled_pipeline_execution_frequency:
                    $ref: "#/pipe_defaults/scheduled_pipeline_execution_frequency"
      pipe_defaults:
        harness_ci_image_source_repository:
          title: Provide the source repository path from which the Harness CI Images will be retrieved
          description: Must be a valid source containing current versions of the Harness CI images. More information can be found in the documentation - https://developer.harness.io/docs/continuous-integration/use-ci/set-up-build-infrastructure/harness-ci/#harness-ci-images-list
          type: string
          default: us-docker.pkg.dev/gar-prod-setup/harness-public/
        customer_image_target_repository:
          title: Provide the Custom Container Registry under which all images will be replicated
          type: string
        container_registry_username_ref:
          title: Reference to Harness Secret containing the Container Registry Username. Defaults to Central Build Farm Container Registry Credentials
          type: string
          default: account.buildfarm_container_registry_username
        container_registry_password_ref:
          title: Reference to Harness Secret containing the Container Registry Password. Defaults to Central Build Farm Container Registry Credentials
          type: string
          default: account.buildfarm_container_registry_password
        should_use_build_farm_credentials:
          title: Should the Build Farm Container Registry credentials be used?
          description: If 'true' the Harness CI Manager will use the Central Build Farm credentials to authenticate to the target Container Registry
          type: boolean
          default: true
        should_update_harness_mgr:
          title: Should the default images be updated to point to the target container registry?
          description: If 'true' the Harness CI Manager will be updated immediately to change the default behaviour of Harness CI to only pull images from those stored in the target container registry.
          type: boolean
          default: true
        should_trigger_pipeline_on_schedule:
          title: Should we enable the execution of this pipeline to run on a schedule?
          description: When enabled, a new trigger will be scheduled to execution and update the pipeline at a regular frequency
          type: boolean
          default: true
        scheduled_pipeline_execution_frequency:
          title: Provide a valid UNIX-style cron schedule
          description: Cron Format schedule for when and how frequently to schedule this pipeline. Default is daily at 2am
          type: string
          default: "0 2 * * *"
    - title: Pipeline Configuration overrides
      properties:
        use_default_configurations:
          title: Should the pipeline use default connectors and images?
          description: |
            When 'true' the following configurations will be used by default
              - Pipeline steps will source images using the Docker Connector - `account.harnessImage`
              - Harness Solutions Factory Script Manager image will be used - `harnesssolutionfactory/harness-python-api-sdk:latest`
              - Harness Container Image Migration tool will be used `plugins/image-migration`
              - Max Concurrency of parallel steps will be limited to 5
          type: boolean
          default: true
      dependencies:
        use_default_configurations:
          allOf:
            - if:
                properties:
                  use_default_configurations:
                    const: false
              then:
                required:
                  - pipeline_step_connector_ref
                  - harness_image_migration_image
                  - hsf_script_mgr_image
                  - max_concurrency
                properties:
                  pipeline_step_connector_ref:
                    title: Provide a valid connector with upstream access to Dockerhub
                    description: Configures the connector from which the Pipeline Step images will be pulled
                    type: string
                    default: account.harnessImage
                  harness_image_migration_image:
                    title: Provide a valid Harness Container Image Migration image
                    description: Harness Container Image Migration tool. Path should be relative to the connector chosen above
                    type: string
                    default: plugins/image-migration
                  hsf_script_mgr_image:
                    title: Provide a valid Harness Solutions Factory Script Manager image
                    description: Harness Solutions Factory Script Manager Image. Path should be relative to the connector chosen above
                    type: string
                    default: harnesssolutionfactory/harness-python-api-sdk:latest
                  max_concurrency:
                    title: How many parallel replications should be run at once?
                    description: Determines the maximum number of concurrent images that should be migrated in parallel
                    type: number
                    default: 5
    - title: Solutions Factory Connection
      properties:
        solutions_factory_details:
          title: Solutions Factory Details
          type: object
          description: |
            ---
            Harness URL : <+variable.account.solutions_factory_endpoint>

            Harness Account : <+account.identifier>

            Solutions Factory Org : <+variable.account.solutions_factory_org>

            Solutions Factory Project : <+variable.account.solutions_factory_project>
          required:
            - harness_account_url
            - harness_account_id
            - harness_org_id
            - harness_project_id
            - template_library_connector
            - template_library_repo
            - template_library_branch
            - template_library_directory
          properties:
            harness_account_url:
              type: string
              default: <+variable.account.solutions_factory_endpoint>
              ui:widget: hidden
            harness_account_id:
              type: string
              default: <+account.identifier>
              ui:widget: hidden
            harness_org_id:
              type: string
              default: <+variable.account.solutions_factory_org>
              ui:widget: hidden
            harness_project_id:
              type: string
              default: <+variable.account.solutions_factory_project>
              ui:widget: hidden
            template_library_connector:
              type: string
              default: <+variable.account.solutions_factory_template_library_connector>
              ui:widget: hidden
            template_library_repo:
              type: string
              default: <+variable.account.solutions_factory_template_library_repo>
              ui:widget: hidden
            template_library_branch:
              type: string
              default: main
              ui:widget: hidden
            template_library_directory:
              type: string
              default: harness-ci-image-factory
              ui:widget: hidden
        solutions_factory_opts:
          title: Solutions Factory Workflow Options
          type: object
          required:
            - repo_source
            - workspace_type
          properties:
            repo_source:
              type: string
              # Used to group by source the workspaces for bulk actions
              default: <+<+variable.account.solutions_factory_template_library_connector>.startsWith("org.Harness_Template_Library_Repo")?"official":"custom">
              ui:widget: hidden
            workspace_type:
              type: string
              # Used to group by type the workspaces for bulk actions
              default: harness-ci-image-factory
              ui:widget: hidden
            is_ephemeral:
              type: string
              # Determines if the workflow will trigger a temporary workspace that is
              # deleted upon completion. Resources will be preserved
              # Must be "true" or "false" and wrapped in quotes
              default: "false"
              ui:widget: hidden
            requires_approval:
              type: string
              # Determines if the workflow will require an Approval before executing
              # Must be "true" or "false" and wrapped in quotes
              default: "false"
              ui:widget: hidden
            use_mini_factory:
              type: string
              # "When enabled, IDP workflows will default to leveraging the mini-factory to distribute workloads
              # Value must be controlled through variable
              default: "false"
              ui:widget: hidden
  steps:
    - id: configure_workspace
      name: Configuring Harness Workspace
      action: trigger:harness-custom-pipeline
      input:
        url: ${{ parameters.solutions_factory_details.harness_account_url }}/ng/account/${{ parameters.solutions_factory_details.harness_account_id }}/all/orgs/${{ parameters.solutions_factory_details.harness_org_id }}/projects/${{ "hws_" if parameters.solutions_factory_opts.use_mini_factory=="true" else "" }}${{ parameters.organization_id if parameters.solutions_factory_opts.use_mini_factory=="true" else parameters.solutions_factory_details.harness_project_id }}/pipelines/Create_and_Manage_IACM_Workspaces/pipeline-studio?storeType=INLINE
        inputset:
          GIT_REPOSITORY_CONNECTOR: ${{ parameters.solutions_factory_details.template_library_connector }}
          GIT_REPOSITORY_NAME: ${{ parameters.solutions_factory_details.template_library_repo }}
          GIT_REPOSITORY_BRANCH: ${{ parameters.solutions_factory_details.template_library_branch }}
          GIT_REPOSITORY_PATH: ${{ parameters.solutions_factory_details.template_library_directory }}
          RESOURCE_NAME: harness_ci_image_factory
          RESOURCE_OWNER: group:default/HSF_Admins
          # YAML of Terraform variables of type 'String' mapped to their IDP parameters
          RESOURCE_VARS:
            organization_id: ${{ parameters.solutions_factory_details.harness_org_id }}
            project_id: Image_Factory
            kubernetes_connector: ${{ "skipped" if (parameters.build_infrastructure_type == "cloud") else ( parameters.infra_defaults.kubernetes_connector if (parameters.build_infrastructure_type == "build_farm") else parameters.kubernetes_connector ) }}
            kubernetes_namespace: ${{ "default" if (parameters.build_infrastructure_type == "cloud") else ( parameters.infra_defaults.kubernetes_namespace if (parameters.build_infrastructure_type == "build_farm") else parameters.kubernetes_namespace ) }}
            kubernetes_node_selectors: ${{ "{}" if (parameters.build_infrastructure_type == "cloud") else ( parameters.kubernetes_node_selectors if parameters.kubernetes_node_selectors else parameters.infra_defaults.kubernetes_node_selectors ) }}
            kubernetes_override_image_connector: ${{ "skipped" if (parameters.build_infrastructure_type == "cloud") else ( parameters.kubernetes_override_image_connector if parameters.kubernetes_override_image_connector else parameters.infra_defaults.kubernetes_override_image_connector ) }}
            harness_ci_image_source_repository: ${{ parameters.infra_defaults.harness_ci_image_source_repository if parameters.use_harness_public_gar_registry else parameters.harness_ci_image_source_repository }}
            customer_image_target_repository: ${{ parameters.customer_image_target_repository }}
            container_registry_username_ref: ${{ parameters.infra_defaults.container_registry_username_ref if parameters.should_use_build_farm_credentials else parameters.container_registry_username_ref }}
            container_registry_password_ref: ${{ parameters.infra_defaults.container_registry_password_ref if parameters.should_use_build_farm_credentials else parameters.container_registry_password_ref }}
            should_update_harness_mgr: ${{ parameters.should_update_harness_mgr }}
            modules: ${{ parameters.modules }}
            pipeline_step_connector_ref: ${{ parameters.infra_defaults.pipeline_step_connector_ref if parameters.use_default_configurations else parameters.pipeline_step_connector_ref }}
            harness_image_migration_image: ${{ parameters.infra_defaults.harness_image_migration_image if parameters.use_default_configurations else parameters.harness_image_migration_image }}
            hsf_script_mgr_image: ${{ parameters.infra_defaults.hsf_script_mgr_image if parameters.use_default_configurations else parameters.hsf_script_mgr_image }}
            max_concurrency: ${{ parameters.infra_defaults.max_concurrency if parameters.use_default_configurations else parameters.max_concurrency }}
            should_trigger_pipeline_on_schedule: ${{ parameters.should_trigger_pipeline_on_schedule }}
            scheduled_pipeline_execution_frequency: ${{ parameters.infra_defaults.scheduled_pipeline_execution_frequency if parameters.should_trigger_pipeline_on_schedule else parameters.scheduled_pipeline_execution_frequency }}
          # YAML of Terraform variables of type 'Secret' Reference mapped to their IDP parameters
          RESOURCE_VARS_SECRETS: {}
          # YAML of Environment variables of type 'String' mapped to their IDP parameters
          RESOURCE_VARS_ENVS: {}
          # YAML of Environment variables of type 'Secret' Reference mapped to their IDP parameters
          RESOURCE_VARS_ENVS_SECRET: {}
          # Should the workspace automatically include the default Harness Connector environment variables
          INCLUDE_HARNESS_ENVS: "true"
          WORKSPACE_TAGS:
            source: ${{ parameters.solutions_factory_opts.repo_source }}
            type: ${{ parameters.solutions_factory_opts.workspace_type }}
          IS_EPHEMERAL: ${{ parameters.solutions_factory_opts.is_ephemeral }}
          REQUIRES_APPROVAL: ${{ parameters.solutions_factory_opts.requires_approval }}
        apikey: ${{ parameters.token }}
        showOutputVariables: true
  output:
    links:
      - title: Deployed Pipeline
        url: ${{ steps.configure_workspace.output['pipeline.stages.Provision.spec.execution.steps.Provision.steps.apply.output.outputVariables.pipeline_url']}}
    text:
      - title: Outputs
        content: |
          ---
          ## Your Harness CI Image Factory Pipeline is operational
          ---
          Click the `Deployed Pipeline` link above to navigate directly to the deployed resource.  Upon navigating to the pipeline, click **RUN** and choose/provide your branch name.

