apiVersion: harness.io/v1
kind: Workflow
identifier: harnesscentralbuildfarmsetup
name: Harness Central Build Farm Setup
owner: group:default/HSF_Admins
type: harness_factory
metadata:
  description: Configures the Connectors for a Centralized Build Farm configuration
  tags:
    - account-management
    - solutions-factory
    - harness
spec:
  parameters:
    - title: Setup Build Farm Infrastructure
      properties:
        # The token property needs to be in the first page of the workflow
        token:
          title: Harness Token
          type: string
          ui:widget: password
          ui:field: HarnessAuthToken
        build_infrastructure_type:
          title: Configure a Kubernetes Connector for use as a Centralized Build Farm
          type: string
          enum:
            - internal
            - cloud
            - both
          enumNames:
            - Self-Hosted Build Infrastructure Only
            - Leverage Harness CI Cloud Infrastructure
            - Support both Self-Hosted and Harness CI Cloud
      dependencies:
        build_infrastructure_type:
          allOf:
            - if:
                properties:
                  build_infrastructure_type:
                    const: internal
              then:
                required:
                  - delegate_selectors
                properties:
                  delegate_selectors:
                    $ref: "#/delegates/selectors"
            - if:
                properties:
                  build_infrastructure_type:
                    const: both
              then:
                required:
                  - delegate_selectors
                properties:
                  delegate_selectors:
                    $ref: "#/delegates/selectors"
      delegates:
        selectors:
          title: Delegate Selectors to attach to the connectors?
          description: Self-hosted infrastructure connectors require that you provide a delegate tag. It is suggested that you apply only one as complex delegate selectors can cause issues with resource selection.
          type: string
          default: build_farm
    - title: Setup Build Farm Source Code Manager
      required:
        - source_code_manager_type
        - source_code_manager_url
        - source_code_manager_validation_repo
      properties:
        source_code_manager_type:
          title: Choose your Source Code Manager Type
          type: string
          description: What type of Source Code Manager Connector type will be used as the default Build Farm SCM. | Enterprise versions require a Harness Delegate to function
          enum:
            - github
            - bitbucket
            - gitlab
          enumNames:
            - GitHub (Cloud or Enterprise)
            - Bitbucket (Cloud or Enterprise)
            - Gitlab (Cloud or Enterprise)
        source_code_manager_url:
          title: Source Code Manager URL
          type: string
          description: Please provide the default URL for the Connector - e.g.
            https://github.com
        source_code_manager_validation_repo:
          title: Validation Repository
          type: string
          description: Please provide the validation URL for the Connector - e.g.
            harness/terraform-provider-harness
      dependencies:
        source_code_manager_type:
          allOf:
            - if:
                properties:
                  source_code_manager_type:
                    const: gitlab
              then:
                required:
                  - source_code_manager_auth_type
                properties:
                  source_code_manager_auth_type:
                    $ref: "#/source_code_manager_auth_type"
      source_code_manager_auth_type:
        title: SCM Authentication Type
        type: string
        description: Provide the default SCM Authentication Type for the connector
        default: http
        enum:
          - http
          - ssh
        enumNames:
          - HTTP
          - SSH
    - title: Setup Build Farm Container Registry
      required:
        - container_registry_type
      properties:
        build_infrastructure_type:
          title: Configure a Kubernetes Connector for use as a Centralized Build Farm
          type: string
          ui:widget: hidden
        container_registry_type:
          title: Choose your Container Registry Type
          type: string
          description: What type of Container Registry Connector type will be used as the default Build Farm Registry
          enum:
            - docker
            - aws
            - gcp
            - azure
          enumNames:
            - DockerHub (or compatible) Registry
            - AWS Cloud Provider
            - Google Cloud Provider
            - Azure Cloud Provider
      dependencies:
        container_registry_type:
          allOf:
            # Docker Connectors
            - if:
                properties:
                  container_registry_type:
                    const: docker
              then:
                required:
                  - container_registry_provider_type
                  - container_registry_url
                properties:
                  container_registry_provider_type:
                    $ref: "#/cr_defaults/docker/container_registry_provider_type"
                  container_registry_url:
                    $ref: "#/cr_defaults/docker/container_registry_url"
            # AWS Connectors
            - if:
                properties:
                  container_registry_type: { const: 'aws' }
                  build_infrastructure_type: { const: 'internal' }
              then:
                required:
                  - region
                  - authentication_type_self_hosted
                properties:
                  region:
                    $ref: "#/cr_defaults/aws/region"
                  authentication_type_self_hosted:
                    $ref: "#/cr_defaults/aws/authentication_type_self_hosted"
            - if:
                properties:
                  container_registry_type: { const: 'aws' }
                  build_infrastructure_type: { const: 'cloud' }
              then:
                required:
                  - region
                  - authentication_type_harness_cloud
                properties:
                  region:
                    $ref: "#/cr_defaults/aws/region"
                  authentication_type_harness_cloud:
                    $ref: "#/cr_defaults/aws/authentication_type_harness_cloud"
            - if:
                properties:
                  container_registry_type: { const: 'aws' }
                  build_infrastructure_type: { const: 'both' }
              then:
                required:
                  - region
                  - authentication_type_self_hosted
                  - authentication_type_harness_cloud
                properties:
                  region:
                    $ref: "#/cr_defaults/aws/region"
                  authentication_type_self_hosted:
                    $ref: "#/cr_defaults/aws/authentication_type_self_hosted"
                  authentication_type_harness_cloud:
                    $ref: "#/cr_defaults/aws/authentication_type_harness_cloud"
            # GCP Connectors
            - if:
                properties:
                  container_registry_type: { const: 'gcp' }
                  build_infrastructure_type: { const: 'internal' }
              then:
                required:
                  - authentication_type_self_hosted
                properties:
                  authentication_type_self_hosted:
                    $ref: "#/cr_defaults/gcp/authentication_type_self_hosted"
            - if:
                properties:
                  container_registry_type: { const: 'gcp' }
                  build_infrastructure_type: { const: 'cloud' }
              then:
                required:
                  - authentication_type_harness_cloud
                properties:
                  authentication_type_harness_cloud:
                    $ref: "#/cr_defaults/gcp/authentication_type_harness_cloud"
            - if:
                properties:
                  container_registry_type: { const: 'gcp' }
                  build_infrastructure_type: { const: 'both' }
              then:
                required:
                  - authentication_type_self_hosted
                  - authentication_type_harness_cloud
                properties:
                  authentication_type_self_hosted:
                    $ref: "#/cr_defaults/gcp/authentication_type_self_hosted"
                  authentication_type_harness_cloud:
                    $ref: "#/cr_defaults/gcp/authentication_type_harness_cloud"
            # Azure Connectors
            - if:
                properties:
                  container_registry_type: { const: 'azure' }
                  build_infrastructure_type: { const: 'internal' }
              then:
                required:
                  - azure_environment_type
                  - authentication_type_self_hosted
                properties:
                  azure_environment_type:
                    $ref: "#/cr_defaults/azure/azure_environment_type"
                  authentication_type_self_hosted:
                    $ref: "#/cr_defaults/azure/authentication_type_self_hosted"
            - if:
                properties:
                  container_registry_type: { const: 'azure' }
                  build_infrastructure_type: { const: 'cloud' }
              then:
                required:
                  - azure_environment_type
                  - authentication_type_harness_cloud
                properties:
                  azure_environment_type:
                    $ref: "#/cr_defaults/azure/azure_environment_type"
                  authentication_type_harness_cloud:
                    $ref: "#/cr_defaults/azure/authentication_type_harness_cloud"
            - if:
                properties:
                  container_registry_type: { const: 'azure' }
                  build_infrastructure_type: { const: 'both' }
              then:
                required:
                  - azure_environment_type
                  - authentication_type_self_hosted
                  - authentication_type_harness_cloud
                properties:
                  azure_environment_type:
                    $ref: "#/cr_defaults/azure/azure_environment_type"
                  authentication_type_self_hosted:
                    $ref: "#/cr_defaults/azure/authentication_type_self_hosted"
                  authentication_type_harness_cloud:
                    $ref: "#/cr_defaults/azure/authentication_type_harness_cloud"
        authentication_type_self_hosted:
          allOf:
            # AWS Connectors
            - if:
                properties:
                  authentication_type_self_hosted: { const: 'oidc' }
                  container_registry_type: { const: 'aws' }
              then:
                required:
                  - iam_role_arn
                properties:
                  iam_role_arn:
                    $ref: "#/cr_defaults/aws/iam_role_arn"
            - if:
                properties:
                  authentication_type_self_hosted: { const: 'delegate' }
                  container_registry_type: { const: 'aws' }
              then:
                properties:
                  cross_account_role_arn:
                    $ref: "#/cr_defaults/aws/cross_account_role_arn"
                  cross_account_external_id:
                    $ref: "#/cr_defaults/aws/cross_account_external_id"
            - if:
                properties:
                  authentication_type_self_hosted: { const: 'irsa' }
                  container_registry_type: { const: 'aws' }
              then:
                properties:
                  cross_account_role_arn:
                    $ref: "#/cr_defaults/aws/cross_account_role_arn"
                  cross_account_external_id:
                    $ref: "#/cr_defaults/aws/cross_account_external_id"
            # GCP Connectors
            - if:
                properties:
                  authentication_type_self_hosted: { const: 'oidc' }
                  container_registry_type: { const: 'gcp' }
              then:
                required:
                  - workload_pool_id
                  - provider_id
                  - project_id
                  - service_account_email
                properties:
                  workload_pool_id:
                    $ref: "#/cr_defaults/gcp/workload_pool_id"
                  provider_id:
                    $ref: "#/cr_defaults/gcp/provider_id"
                  project_id:
                    $ref: "#/cr_defaults/gcp/project_id"
                  service_account_email:
                    $ref: "#/cr_defaults/gcp/service_account_email"
            # Azure Connectors
            - if:
                properties:
                  authentication_type_self_hosted: { const: 'secret' }
                  container_registry_type: { const: 'azure' }
              then:
                required:
                  - azure_application_id
                  - azure_tenant_id
                properties:
                  azure_application_id:
                    $ref: "#/cr_defaults/azure/azure_application_id"
                  azure_tenant_id:
                    $ref: "#/cr_defaults/azure/azure_tenant_id"
            - if:
                properties:
                  authentication_type_self_hosted: { const: 'certificate' }
                  container_registry_type: { const: 'azure' }
              then:
                required:
                  - azure_application_id
                  - azure_tenant_id
                properties:
                  azure_application_id:
                    $ref: "#/cr_defaults/azure/azure_application_id"
                  azure_tenant_id:
                    $ref: "#/cr_defaults/azure/azure_tenant_id"
            - if:
                properties:
                  authentication_type_self_hosted: { const: 'delegate' }
                  container_registry_type: { const: 'azure' }
              then:
                properties:
                  azure_delegate_auth_type:
                    $ref: "#/cr_defaults/azure/azure_delegate_auth_type"
        authentication_type_harness_cloud:
          allOf:
            # AWS Connectors
            - if:
                properties:
                  authentication_type_harness_cloud: { const: 'oidc' }
                  container_registry_type: { const: 'aws' }
              then:
                required:
                  - iam_role_arn
                properties:
                  iam_role_arn:
                    $ref: "#/cr_defaults/aws/iam_role_arn"
            # GCP Connectors
            - if:
                properties:
                  authentication_type_harness_cloud: { const: 'oidc' }
                  container_registry_type: { const: 'gcp' }
              then:
                required:
                  - workload_pool_id
                  - provider_id
                  - project_id
                  - service_account_email
                properties:
                  workload_pool_id:
                    $ref: "#/cr_defaults/gcp/workload_pool_id"
                  provider_id:
                    $ref: "#/cr_defaults/gcp/provider_id"
                  project_id:
                    $ref: "#/cr_defaults/gcp/project_id"
                  service_account_email:
                    $ref: "#/cr_defaults/gcp/service_account_email"
            # Azure Connectors
            - if:
                properties:
                  authentication_type_harness_cloud: { const: 'secret' }
                  container_registry_type: { const: 'azure' }
              then:
                required:
                  - azure_application_id
                  - azure_tenant_id
                properties:
                  azure_application_id:
                    $ref: "#/cr_defaults/azure/azure_application_id"
                  azure_tenant_id:
                    $ref: "#/cr_defaults/azure/azure_tenant_id"
            - if:
                properties:
                  authentication_type_harness_cloud: { const: 'certificate' }
                  container_registry_type: { const: 'azure' }
              then:
                required:
                  - azure_application_id
                  - azure_tenant_id
                properties:
                  azure_application_id:
                    $ref: "#/cr_defaults/azure/azure_application_id"
                  azure_tenant_id:
                    $ref: "#/cr_defaults/azure/azure_tenant_id"
        azure_delegate_auth_type:
          allOf:
            - if:
                properties:
                  azure_delegate_auth_type: { const: 'user' }
                  container_registry_type: { const: 'azure' }
              then:
                required:
                  - azure_user_assigned_client_id
                properties:
                  azure_user_assigned_client_id:
                    $ref: "#/cr_defaults/azure/azure_user_assigned_client_id"
      cr_defaults:
        docker:
          container_registry_provider_type:
            title: Container Registry Type
            type: string
            description: Choose a Generic Container Registry Type
            enum:
              - DockerHub
              - Other
              - Harbor
              - Quay
            enumNames:
              - DockerHub
              - Artifactory/Nexus/Other
              - Harbor
              - Quay
          container_registry_url:
            title: Container Registry URL
            type: string
            description: Provide the URL to which the Container Registry connector will connect - e.g. https://index.docker.io/v2/
        aws:
          region:
            title: AWS Region
            type: string
            description: Provide the default AWS Region for the connector
            default: us-east-1
          authentication_type_self_hosted:
            title: AWS Authentication Type - Self-Hosted Infrastructure
            type: string
            description: Provide the default AWS Authentication Type for the connector
            default: oidc
            enum:
              - manual
              - delegate
              - irsa
              - oidc
            enumNames:
              - Access Key & Secret Key
              - Inherit from the Delegate
              - Use IRSA
              - Leverage OIDC Authentication
          authentication_type_harness_cloud:
            title: AWS Authentication Type - Harness Cloud
            type: string
            description: Provide the default AWS Authentication Type for the connector
            default: oidc
            enum:
              - manual
              - oidc
            enumNames:
              - Access Key & Secret Key
              - Leverage OIDC Authentication
          iam_role_arn:
            title: AWS IAM Role ARN
            type: string
            description: Provide the AWS IAM Role for the connector
          cross_account_role_arn:
            title: Cross account role ARN
            type: string
            description: The Amazon Resource Name (ARN) of the role that you want to assume. This is an IAM role in the target AWS account.
          cross_account_external_id:
            title: External Id
            type: string
            description: If the administrator of the account to which the role belongs provided you with an external Id, then enter that value.
        gcp:
          authentication_type_self_hosted:
            title: GCP Authentication Type - Self-Hosted Infrastructure
            type: string
            description: Provide the default GCP Authentication Type for the connector
            default: oidc
            enum:
              - manual
              - delegate
              - oidc
            enumNames:
              - Access Key & Secret Key
              - Inherit from the Delegate
              - Leverage OIDC Authentication
          authentication_type_harness_cloud:
            title: GCP Authentication Type - Harness Cloud
            type: string
            description: Provide the default GCP Authentication Type for the connector
            default: oidc
            enum:
              - manual
              - oidc
            enumNames:
              - Access Key & Secret Key
              - Leverage OIDC Authentication
          workload_pool_id:
            title: GCP Pool ID
            type: string
            description: Workload Pool ID for OIDC authentication
          provider_id:
            title: GCP Provider ID
            type: string
            description: Provider ID for OIDC authentication
          project_id:
            title: GCP Project ID
            type: string
            description: GCP Project ID for OIDC authentication
          service_account_email:
            title: GCP Service Account Email
            type: string
            description: Service Account Email for OIDC authentication
        azure:
          authentication_type_self_hosted:
            title: Azure Authentication Type - Self-Hosted Infrastructure
            type: string
            description: Provide the default Azure Authentication Type for the connector
            default: delegate
            enum:
              - secret
              - certificate
              - delegate
            enumNames:
              - Service Principal Secret
              - Service Principal Certificate
              - Managed Identity on Delegate
          authentication_type_harness_cloud:
            title: Azure Authentication Type - Harness Cloud
            type: string
            description: Provide the default Azure Authentication Type for the connector
            default: certificate
            enum:
              - secret
              - certificate
            enumNames:
              - Service Principal Secret
              - Service Principal Certificate
          azure_environment_type:
            title: Choose your Azure Cloud Type
            type: string
            description: Select Azure Global or US Government
            default: AZURE
            enum:
              - AZURE
              - AZURE_US_GOVERNMENT
            enumNames:
              - Azure Global
              - US Government
          azure_application_id:
            title: Azure application ID for authentication
            type: string
            description: This is the Application (Client) Id for the Azure app registration you are using
          azure_tenant_id:
            title: Azure tenant ID for authentication
            type: string
            description: The Tenant Id is the Id of the Azure Active Directory (AAD) in which you created your application.
          azure_delegate_auth_type:
            title: Select the Managed Identity type
            type: string
            description: Select System Assigned Managed Identity or User Assigned Managed Identity.
            default: system
            enum:
              - system
              - user
            enumNames:
              - System Assigned Managed Identity
              - User Assigned Managed Identity
          azure_user_assigned_client_id:
            title: Client ID for User Assigned Managed Identity
            type: string
            description: The Tenant Id is the Id of the Azure Active Directory (AAD) in which you created your application.
    - title: Setup Build Farm Artifact Manager
      properties:
        build_infrastructure_type:
          title: Configure a Kubernetes Connector for use as a Centralized Build Farm
          type: string
          ui:widget: hidden
        should_setup_artifact_manager:
          title: Should we set up a Central Build Farm Artifact Manager?
          type: boolean
          description: When enabled, a new Artifact Manager Connector will be created.
          default: true
      dependencies:
        should_setup_artifact_manager:
          allOf:
            - if:
                properties:
                  should_setup_artifact_manager:
                    const: true
              then:
                required:
                  - artifact_manager_type
                  - artifact_manager_url
                properties:
                  artifact_manager_type:
                    title: Choose your Artifact Manager Type
                    type: string
                    description: What type of Artifact Manager Connector type will be used as the
                      default Build Farm Registry
                    enum:
                      - artifactory
                      - nexus
                      - http_helm
                      - oci_helm
                    enumNames:
                      - Artifactory
                      - Nexus
                      - Helm HTTP
                      - Helm OCI
                  artifact_manager_url:
                    title: Artifact Manager URL
                    type: string
                    description: Please provide the default URL for the Connector - e.g.
                      https://mycompany.jfrog.io/module_name/
        artifact_manager_type:
          allOf:
            - if:
                properties:
                  artifact_manager_type:
                    const: http_helm
              then:
                required:
                  - artifact_manager_auth_type
                  - artifact_manager_delegate
                properties:
                  artifact_manager_auth_type:
                    $ref: "#/artifact_manager_auth_type"
                  artifact_manager_delegate:
                    $ref: "#/artifact_manager_delegate"
            - if:
                properties:
                  artifact_manager_type:
                    const: oci_helm
              then:
                required:
                  - artifact_manager_auth_type
                  - artifact_manager_delegate
                properties:
                  artifact_manager_auth_type:
                    $ref: "#/artifact_manager_auth_type"
                  artifact_manager_delegate:
                    $ref: "#/artifact_manager_delegate"
            - if:
                properties:
                  artifact_manager_type:
                    const: nexus
              then:
                required:
                  - artifact_manager_auth_type
                  - nexus_version
                  - artifact_manager_delegate
                properties:
                  artifact_manager_auth_type:
                    $ref: "#/artifact_manager_auth_type"
                  nexus_version:
                    $ref: "#/nexus_version"
                  artifact_manager_delegate:
                    $ref: "#/artifact_manager_delegate"
            - if:
                properties:
                  artifact_manager_type:
                    const: artifactory
                  build_infrastructure_type:
                    const: internal
              then:
                required:
                  - artifact_manager_delegate
                properties:
                  artifact_manager_delegate:
                    $ref: "#/artifact_manager_delegate"
            - if:
                properties:
                  artifact_manager_type:
                    const: artifactory
                  build_infrastructure_type:
                    const: both
              then:
                required:
                  - artifact_manager_delegate
                properties:
                  artifact_manager_delegate:
                    $ref: "#/artifact_manager_delegate"
      artifact_manager_auth_type:
        title: Artifact Manager Authentication Type
        type: string
        description: Provide the default Artifact Manager Authentication Type for the
          connector
        default: Anonymous
        enum:
          - UsernamePassword
          - Anonymous
        enumNames:
          - UsernamePassword
          - Anonymous
      artifact_manager_delegate:
        title: Delegate Selectors to attach to the artifact manager connectors?
        description: Self-hosted infrastructure connectors require that you provide a
          delegate tag. It is suggested that you apply only one as complex
          delegate selectors can cause issues with resource selection.
        type: string
        default: build_farm
      nexus_version:
        title: Nexus Server Version
        type: string
        description: Provide the default Nexus Server Version for the connector
        default: 2.x
        enum:
          - 2.x
          - 3.x
        enumNames:
          - 2.x
          - 3.x
    - title: Solutions Factory Connection
      properties:
        solutions_factory_details:
          title: Solutions Factory Details
          type: object
          description: |
            ---
            Harness URL : <+<+variable.account.solutions_factory_endpoint>.replaceFirst("/*$","")>

            Harness Account : <+account.identifier>

            Solutions Factory Org : <+variable.account.solutions_factory_org>

            Solutions Factory Project : <+variable.account.solutions_factory_project>

            Template Library Connector : <+variable.account.solutions_factory_template_library_connector>
          required:
            - harness_account_url
            - harness_account_id
            - harness_org_id
            - harness_project_id
            - template_library_connector
            - template_library_repo
            - template_library_branch
            - template_library_directory
          properties:
            harness_account_url:
              type: string
              default: <+<+variable.account.solutions_factory_endpoint>.replaceFirst("/*$","")>
              ui:widget: hidden
            harness_account_id:
              type: string
              default: <+account.identifier>
              ui:widget: hidden
            harness_org_id:
              type: string
              default: <+variable.account.solutions_factory_org>
              ui:widget: hidden
            harness_project_id:
              type: string
              default: <+variable.account.solutions_factory_project>
              ui:widget: hidden
            template_library_connector:
              type: string
              default: <+variable.account.solutions_factory_template_library_connector>
              ui:widget: hidden
            template_library_repo:
              type: string
              default: <+variable.account.solutions_factory_template_library_repo>
              ui:widget: hidden
            template_library_branch:
              type: string
              default: main
              ui:widget: hidden
            template_library_directory:
              type: string
              default: central-build-farm-setup
              ui:widget: hidden
        solutions_factory_opts:
          title: Solutions Factory Workflow Options
          type: object
          required:
            - repo_source
            - workspace_type
          properties:
            repo_source:
              type: string
              # Used to group by source the workspaces for bulk actions
              default: <+<+variable.account.solutions_factory_template_library_connector>.startsWith("org.Harness_Template_Library_Repo")?"official":"custom">
              ui:widget: hidden
            workspace_type:
              type: string
              # Used to group by type the workspaces for bulk actions
              default: central-build-farm-setup
              ui:widget: hidden
            is_ephemeral:
              type: string
              # Determines if the workflow will trigger a temporary workspace that is
              # deleted upon completion. Resources will be preserved
              # Must be "true" or "false" and wrapped in quotes
              default: "false"
              ui:widget: hidden
            requires_approval:
              type: string
              # Determines if the workflow will require an Approval before executing
              # Must be "true" or "false" and wrapped in quotes
              default: "false"
              ui:widget: hidden
            use_mini_factory:
              type: string
              # "When enabled, IDP workflows will default to leveraging the mini-factory to distribute workloads
              # Value must be controlled through variable
              default: "false"
              ui:widget: hidden
  steps:
    - id: configure_workspace
      name: Configuring Harness Workspace
      action: trigger:harness-custom-pipeline
      input:
        url: ${{ parameters.solutions_factory_details.harness_account_url }}/ng/account/${{ parameters.solutions_factory_details.harness_account_id }}/all/orgs/${{ parameters.solutions_factory_details.harness_org_id }}/projects/${{ "hws_" if parameters.solutions_factory_opts.use_mini_factory=="true" else "" }}${{ parameters.organization_id if parameters.solutions_factory_opts.use_mini_factory=="true" else parameters.solutions_factory_details.harness_project_id }}/pipelines/Create_and_Manage_IACM_Workspaces/pipeline-studio?storeType=INLINE
        inputset:
          GIT_REPOSITORY_CONNECTOR: ${{ parameters.solutions_factory_details.template_library_connector }}
          GIT_REPOSITORY_NAME: ${{ parameters.solutions_factory_details.template_library_repo }}
          GIT_REPOSITORY_BRANCH: ${{ parameters.solutions_factory_details.template_library_branch }}
          GIT_REPOSITORY_PATH: ${{ parameters.solutions_factory_details.template_library_directory }}
          RESOURCE_NAME: harness-central-build-farm-setup
          RESOURCE_OWNER: group:default/Account_Admins
          RESOURCE_VARS:
            build_infrastructure_type: ${{ parameters.build_infrastructure_type }}
            delegate_selectors: ["${{ parameters.delegate_selectors }}"]
            source_code_manager_type: ${{ parameters.source_code_manager_type }}
            source_code_manager_url: ${{ parameters.source_code_manager_url }}
            source_code_manager_validation_repo: ${{ parameters.source_code_manager_validation_repo }}
            source_code_manager_auth_type: ${{ parameters.source_code_manager_auth_type }}
            authentication_type_self_hosted: ${{ parameters.authentication_type_self_hosted }}
            authentication_type_harness_cloud: ${{ parameters.authentication_type_harness_cloud }}
            container_registry_type: ${{ parameters.container_registry_type }}
            # Generic Docker
            container_registry_url: ${{ parameters.container_registry_url }}
            container_registry_provider_type: ${{ parameters.container_registry_provider_type }}
            # AWS Connectors
            region: ${{ parameters.region }}
            iam_role_arn: ${{ parameters.iam_role_arn }}
            aws_cross_account_role_arn: ${{ parameters.cross_account_role_arn }}
            aws_cross_account_external_id: ${{ parameters.cross_account_external_id }}
            # GCP Connectors
            gcp_workload_pool_id: ${{ parameters.workload_pool_id }}
            gcp_provider_id: ${{ parameters.provider_id }}
            gcp_project_id: ${{ parameters.project_id }}
            gcp_service_account_email: ${{ parameters.service_account_email }}
            # Azure Connectors
            azure_application_id: ${{ parameters.azure_application_id }}
            azure_tenant_id: ${{ parameters.azure_tenant_id }}
            azure_environment_type: ${{ parameters.azure_environment_type }}
            azure_user_assigned_client_id: ${{ parameters.azure_user_assigned_client_id }}
            artifact_manager_type: ${{ parameters.artifact_manager_type }}
            artifact_manager_url: ${{ parameters.artifact_manager_url if parameters.should_setup_artifact_manager else "skipped" }}
            artifact_manager_auth_type: ${{ parameters.artifact_manager_auth_type }}
            nexus_version: ${{ parameters.nexus_version }}
            artifact_manager_delegate: ["${{ parameters.artifact_manager_delegate }}"]
          RESOURCE_VARS_ENVS: {}
          RESOURCE_VARS_ENVS_SECRET: {}
          RESOURCE_VARS_SECRETS: {}
          INCLUDE_HARNESS_ENVS: "true"
          WORKSPACE_TAGS:
            source: ${{ parameters.solutions_factory_opts.repo_source }}
            type: ${{ parameters.solutions_factory_opts.workspace_type }}
          IS_EPHEMERAL: ${{ parameters.solutions_factory_opts.is_ephemeral }}
          REQUIRES_APPROVAL: ${{ parameters.solutions_factory_opts.requires_approval }}
        apikey: ${{ parameters.token }}
  output:
    links:
      - title: Harness Workspace Configured - Execution Link
        url: ${{ steps.configure_workspace.output.PipelineUrl }}
    text:
      - title: Next-Steps
        content: |
          Upon successful execution of this Terraform template, the following items will need to be finalized.

          Step 1) Update the following Account Secrets with their correct values:
          ${{ parameters.solutions_factory_details.harness_account_url }}/ng/account/${{ parameters.solutions_factory_details.harness_account_id }}/all/settings/secrets

            - BuildFarm Container Registry Username
            - BuildFarm Container Registry Password
            - BuildFarm SourceCode Manager Username
            - BuildFarm SourceCode Manager Password
          {% if parameters.build_infrastructure_type != "cloud" %}
          Step 2) Deploy an Account Level delegate. Be sure to include the following tag(s) in the configuration:
          ${{ parameters.solutions_factory_details.harness_account_url }}/ng/account/${{ parameters.solutions_factory_details.harness_account_id }}/all/settings/delegates/list
          - build-farm
          {% endif %}
      - title: Outputs
        content: |
          ## Central Build Farm Connector Details
          {% if parameters.build_infrastructure_type != "cloud" %}
          ### Kubernetes Connector
          - build_farm_connector: ${{ steps.configure_workspace.output['pipeline.stages.Provision.spec.execution.steps.Provision.steps.apply.output.outputVariables.build_farm_connector']}}
          {% endif %}

          ### Container Registry
          {% if parameters.build_infrastructure_type != "cloud" %}
          - build_farm_container_registry (Requires Delegate): ${{ steps.configure_workspace.output['pipeline.stages.Provision.spec.execution.steps.Provision.steps.apply.output.outputVariables.build_farm_container_registry']}}
          {% endif %}

          {% if parameters.build_infrastructure_type != "internal" %}
          - build_farm_container_registry (Used by Harness CI Cloud): ${{ steps.configure_workspace.output['pipeline.stages.Provision.spec.execution.steps.Provision.steps.apply.output.outputVariables.build_farm_container_registry_cloud']}}
          {% endif %}
          ### Source Code Manager
          {% if parameters.build_infrastructure_type != "cloud" %}
          - build_farm_source_code_manager (Requires Delegate): ${{ steps.configure_workspace.output['pipeline.stages.Provision.spec.execution.steps.Provision.steps.apply.output.outputVariables.build_farm_source_code_manager']}}
          {% endif %}

          {% if parameters.build_infrastructure_type != "internal" %}
          - build_farm_source_code_manager (Used by Harness CI Cloud): ${{ steps.configure_workspace.output['pipeline.stages.Provision.spec.execution.steps.Provision.steps.apply.output.outputVariables.build_farm_source_code_manager_cloud']}}
          {% endif %}

          {% if parameters.should_setup_artifact_manager %}
          ### Artifact Manager
          {% if parameters.build_infrastructure_type != "cloud" %}
          - build_farm_artifact_manager (Requires Delegate): ${{ steps.configure_workspace.output['pipeline.stages.Provision.spec.execution.steps.Provision.steps.apply.output.outputVariables.build_farm_artifact_manager']}}
          {% endif %}

          {% if parameters.build_infrastructure_type != "internal" %}
          - build_farm_artifact_manager (Used by Harness CI Cloud): ${{ steps.configure_workspace.output['pipeline.stages.Provision.spec.execution.steps.Provision.steps.apply.output.outputVariables.build_farm_artifact_manager_cloud']}}
          {% endif %}
          {% endif %}
